<?xml version="1.0" encoding="UTF-8"?>
<prompt>
  <metadata>
    <title>Push Notifications for Ticketing System</title>
    <phase>Feature Implementation</phase>
    <difficulty>high</difficulty>
    <estimated_time>3-4 hours</estimated_time>
    <version>1.0</version>
    <last_updated>2025-11-25</last_updated>
    <prerequisites>
      <prerequisite>Push notification provider credentials (e.g., Firebase, OneSignal, Vapid)</prerequisite>
      <prerequisite>Service Worker setup (if PWA)</prerequisite>
    </prerequisites>
  </metadata>

  <thinking_configuration>
    <claude_extended_thinking>
      <enabled>true</enabled>
      <reasoning>
        Implementing push notifications involves both frontend (service workers, permissions) and backend (triggering notifications, managing subscriptions).
      </reasoning>
      <budget_tokens>30000</budget_tokens>
      <expected_thinking_depth>
        Design the notification flow: Trigger (Accept/Cancel) -> Backend Event -> Notification Service -> User Device. Choose the right library/service.
      </expected_thinking_depth>
    </claude_extended_thinking>
  </thinking_configuration>

  <context>
    <project_info>
      <name>Hugo Automotriz</name>
      <current_location>.</current_location>
      <framework>Next.js</framework>
      <status>In Development</status>
    </project_info>
    <objective>
      <primary>
        Implement push notifications for the ticketing system to alert users when a request is accepted or cancelled.
      </primary>
      <success_criteria>
        <criterion>✅ User receives a push notification when their ticket is accepted.</criterion>
        <criterion>✅ User receives a push notification when their ticket is cancelled.</criterion>
      </success_criteria>
    </objective>
  </context>

  <instructions>
    <step number="1">
      <title>Setup Notification Provider</title>
      <thinking_guidance>
        Select a provider (e.g., Firebase Cloud Messaging) or use Web Push API directly.
        1.  Configure environment variables.
        2.  Set up the service worker for handling background messages.
      </thinking_guidance>
      <action>
        Install necessary dependencies and configure the notification provider.
      </action>
    </step>

    <step number="2">
      <title>Implement Subscription Logic</title>
      <thinking_guidance>
        Determine where to ask for permission (e.g., on login or dashboard load).
        1.  Request notification permission from the browser.
        2.  Save the subscription token to the user's profile in the database.
      </thinking_guidance>
      <action>
        Create the frontend logic to request permission and the backend API to store the subscription.
      </action>
    </step>

    <step number="3">
      <title>Trigger Notifications on Events</title>
      <thinking_guidance>
        Identify the backend functions that handle "Accept" and "Cancel" actions.
        1.  Inject the notification sending logic into these functions.
        2.  Construct the message payload (title, body, url).
      </thinking_guidance>
      <action>
        Update the ticket acceptance and cancellation controllers to send push notifications to the relevant user.
      </action>
      <validation>
        <execution_success>
          ✅ Notification provider is configured and working.
          ✅ Subscription logic is implemented and working.
          ✅ Notification sent when creating a service ticket.
          ✅ Performing an "Accept" action triggers a notification.
          ✅ Performing a "Cancel" action triggers a notification.
        </execution_success>
      </validation>
    </step>
  </instructions>

  <output_format>
    <structure>
      <section name="execution_log">
        Log of setup and implementation steps.
      </section>
      <section name="results">
        Verification of notification delivery.
      </section>
    </structure>
    <format>Markdown</format>
  </output_format>
</prompt>
